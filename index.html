<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ScanLiftLog</title>
  <style>
    :root { --b:#111; --g:#666; --l:#e7e7e7; --bg:#fafafa; --card:#fff; }
    body { margin:0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; background:var(--bg); color:var(--b); }
    .wrap { max-width: 900px; margin: 0 auto; padding: 18px; }
    .top { display:flex; align-items:flex-start; justify-content:space-between; gap:12px; flex-wrap:wrap; }
    h1 { margin:0; font-size: 20px; letter-spacing: .2px; }
    .sub { margin:6px 0 0; color:var(--g); font-size: 13px; }
    .pills { display:flex; gap:8px; flex-wrap:wrap; }
    .pill { font-size:12px; padding:8px 10px; border:1px solid var(--l); background:#fff; border-radius:999px; }
    .card { margin-top:14px; background:var(--card); border:1px solid var(--l); border-radius:14px; padding:14px; }
    label { display:block; font-size: 12px; color:var(--g); margin: 0 0 6px; }
    input { width: 100%; box-sizing:border-box; padding:10px 12px; border:1px solid #ddd; border-radius:12px; font-size:14px; background:#fff; }
    button { padding:10px 12px; border-radius:12px; border:1px solid #ddd; background:#fff; cursor:pointer; font-weight:800; }
    button.primary { border:0; background:#111; color:#fff; }
    button.danger { border:0; background:#b00020; color:#fff; }
    .btnrow { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row { display:flex; gap:12px; flex-wrap:wrap; }
    .col { flex:1; min-width: 220px; }
    .muted { color:var(--g); font-size:12px; }
    .hr { height:1px; background:var(--l); margin:14px 0; }
    .smalllink { border:0; background:transparent; text-decoration:underline; cursor:pointer; font-size:12px; opacity:0.75; padding:0; font-weight:700; }
    .badge { display:inline-block; font-size:11px; padding:4px 8px; border:1px solid var(--l); border-radius:999px; background:#fff; color:var(--g); }

    /* Sets grid */
    .setsHeader { display:grid; grid-template-columns: 52px 1fr 1fr 60px; gap:10px; align-items:center; margin-top:10px; }
    .setRow { display:grid; grid-template-columns: 52px 1fr 1fr 60px; gap:10px; align-items:center; margin-top:10px; }
    .setBadge { display:inline-flex; align-items:center; justify-content:center; width:48px; height:40px; border:1px solid var(--l); border-radius:12px; background:#fff; font-weight:900; }
    .iconBtn { width:44px; height:40px; border-radius:12px; border:1px solid #ddd; display:inline-flex; align-items:center; justify-content:center; font-size:18px; font-weight:900; background:#fff; }
    .iconBtn.primary { background:#111; color:#fff; border:0; }
    .iconBtn.danger { background:#b00020; color:#fff; border:0; }

    /* History */
    table { width:100%; border-collapse:collapse; }
    th, td { text-align:left; padding:10px 8px; border-bottom:1px solid var(--l); font-size: 13px; vertical-align:top; }
    th { color:var(--g); font-weight:900; font-size:12px; }
    details summary { cursor:pointer; font-weight:900; }
    .setsMini { margin-top:8px; width:100%; border-collapse:collapse; }
    .setsMini td, .setsMini th { font-size: 12px; padding:6px 6px; border-bottom:1px solid var(--l); }
    footer { margin:16px 0 6px; text-align:center; color:var(--g); font-size:12px; }
    footer a { color:inherit; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="top">
      <div>
        <h1>ScanLiftLog</h1>
        <div class="sub">Scan a machine QR code to view and log your workout history.</div>
      </div>

      <div class="pills">
        <div class="pill" id="machinePill">Loading…</div>
        <div class="pill" id="userPill">User: …</div>
        <div class="pill"><button class="smalllink" id="resetUserBtn" type="button">Reset User ID</button></div>
      </div>
    </div>

    <!-- Logger -->
    <div class="card">
      <div class="row" style="align-items:flex-end;">
        <div class="col">
          <label>Date</label>
          <input id="dateInput" type="date" />
        </div>
        <div class="col">
          <label>Notes (optional)</label>
          <input id="notesInput" placeholder="e.g., controlled reps, last set to failure" />
        </div>
      </div>

      <div class="hr"></div>

      <div style="font-weight:900;">Sets</div>
      <div class="muted" style="margin-top:6px;">Use + to add sets. Each set stores weight and reps.</div>

      <div class="setsHeader">
        <div class="muted">Set</div>
        <div class="muted">Weight</div>
        <div class="muted">Reps</div>
        <div class="muted">Del</div>
      </div>

      <div id="setsContainer"></div>

      <div class="btnrow" style="margin-top:12px;">
        <button class="iconBtn primary" id="addSetBtn" type="button">+</button>
        <div class="muted">Add set</div>
      </div>

      <div class="btnrow" style="margin-top:14px;">
        <button class="primary" id="saveWorkoutBtn" type="button">Save Workout</button>
        <button id="clearCurrentBtn" type="button">Clear Current Sets</button>
        <button class="danger" id="clearHistoryBtn" type="button">Clear All History (this machine)</button>
      </div>
    </div>

    <!-- History -->
    <div class="card">
      <div class="row" style="align-items:center; justify-content:space-between;">
        <div style="font-weight:900;">History</div>
        <div class="badge" id="historyScopeBadge">Scope: …</div>
      </div>

      <div style="margin-top:10px; overflow:auto;">
        <table>
          <thead>
            <tr>
              <th style="min-width:110px;">Date</th>
              <th style="min-width:70px;">Sets</th>
              <th style="min-width:120px;">Top Set</th>
              <th>Details</th>
              <th style="min-width:140px;">Saved</th>
            </tr>
          </thead>
          <tbody id="historyBody">
            <tr><td colspan="5" class="muted">No workouts saved yet.</td></tr>
          </tbody>
        </table>
      </div>

      <div class="muted" style="margin-top:10px;">
        Example QR link format:
        <span class="badge">?machine=SHPR-001</span>
      </div>
    </div>

    <footer>
      © <span id="year"></span> ScanLiftLog •
      <a href="https://spiazzi11-png.github.io/scanliftlog/" target="_blank" rel="noopener">Home</a>
    </footer>
  </div>

<script>
/* ---------- Utilities ---------- */
function getQueryParam(name) {
  const url = new URL(window.location.href);
  return url.searchParams.get(name);
}
function todayISO() {
  const d = new Date();
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth()+1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}
function nowReadable() {
  return new Date().toLocaleString();
}
function safeJSONParse(s, fallback) {
  try { return JSON.parse(s); } catch { return fallback; }
}
function escapeHtml(str) {
  return String(str).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[m]));
}

/* ---------- User ID (device-local) ---------- */
const USER_KEY = 'scanliftlog_user_v1';
function getOrCreateUserId() {
  let id = localStorage.getItem(USER_KEY);
  if (!id) {
    id = 'u_' + Math.random().toString(16).slice(2) + Date.now().toString(16);
    localStorage.setItem(USER_KEY, id);
  }
  return id;
}
function resetUser() {
  localStorage.removeItem(USER_KEY);
  location.reload();
}

/* ---------- UI State ---------- */
const userId = getOrCreateUserId();
const machineId = (getQueryParam('machine') || 'SHPR-001')
  .trim()
  .toUpperCase();

/* ---------- Full Machine Map ---------- */
const MACHINE_MAP = {
  // ---- Chest ----
  "CHPR-001": "Flat Chest Press — Machine 1",
  "CHPR-002": "Flat Chest Press — Machine 2",
  "CHPR-003": "Flat Chest Press — Machine 3",

  "INCHPR-001": "Incline Chest Press — Machine 1",
  "INCHPR-002": "Incline Chest Press — Machine 2",
  "INCHPR-003": "Incline Chest Press — Machine 3",

  "DECHPR-001": "Decline Chest Press — Machine 1",
  "DECHPR-002": "Decline Chest Press — Machine 2",
  "DECHPR-003": "Decline Chest Press — Machine 3",

  "PECDK-001": "Pec Deck / Chest Fly — Machine 1",
  "PECDK-002": "Pec Deck / Chest Fly — Machine 2",
  "PECDK-003": "Pec Deck / Chest Fly — Machine 3",

  "CABFLY-001": "Cable Fly (Chest) — Station 1",
  "CABFLY-002": "Cable Fly (Chest) — Station 2",
  "CABFLY-003": "Cable Fly (Chest) — Station 3",

  "SMTH-001": "Smith Machine — Rack 1",
  "SMTH-002": "Smith Machine — Rack 2",
  "SMTH-003": "Smith Machine — Rack 3",

  // ---- Shoulders ----
  "SHPR-001": "Shoulder Press — Machine 1",
  "SHPR-002": "Shoulder Press — Machine 2",
  "SHPR-003": "Shoulder Press — Machine 3",

  "LATRL-001": "Lateral Raise — Machine 1",
  "LATRL-002": "Lateral Raise — Machine 2",
  "LATRL-003": "Lateral Raise — Machine 3",

  "RDLT-001": "Rear Delt Fly — Machine 1",
  "RDLT-002": "Rear Delt Fly — Machine 2",
  "RDLT-003": "Rear Delt Fly — Machine 3",

  "UPROW-001": "Upright Row — Machine 1",
  "UPROW-002": "Upright Row — Machine 2",
  "UPROW-003": "Upright Row — Machine 3",

  // ---- Back ----
  "LATPD-001": "Lat Pulldown — Station 1",
  "LATPD-002": "Lat Pulldown — Station 2",
  "LATPD-003": "Lat Pulldown — Station 3",

  "SETRW-001": "Seated Row — Machine 1",
  "SETRW-002": "Seated Row — Machine 2",
  "SETRW-003": "Seated Row — Machine 3",

  "HIRW-001": "High Row — Machine 1",
  "HIRW-002": "High Row — Machine 2",
  "HIRW-003": "High Row — Machine 3",

  "ASSTPD-001": "Assisted Pull-Up / Dip — Station 1",
  "ASSTPD-002": "Assisted Pull-Up / Dip — Station 2",
  "ASSTPD-003": "Assisted Pull-Up / Dip — Station 3",

  "STRPD-001": "Straight-Arm Pulldown — Station 1",
  "STRPD-002": "Straight-Arm Pulldown — Station 2",
  "STRPD-003": "Straight-Arm Pulldown — Station 3",

  "BKEXT-001": "Back Extension — Station 1",
  "BKEXT-002": "Back Extension — Station 2",
  "BKEXT-003": "Back Extension — Station 3",

  // ---- Legs ----
  "LEGPR-001": "Leg Press — Machine 1",
  "LEGPR-002": "Leg Press — Machine 2",
  "LEGPR-003": "Leg Press — Machine 3",

  "HKSQ-001": "Hack Squat — Machine 1",
  "HKSQ-002": "Hack Squat — Machine 2",
  "HKSQ-003": "Hack Squat — Machine 3",

  "SQMT-001": "Squat Machine — Machine 1",
  "SQMT-002": "Squat Machine — Machine 2",
  "SQMT-003": "Squat Machine — Machine 3",

  "LEGEX-001": "Leg Extension — Machine 1",
  "LEGEX-002": "Leg Extension — Machine 2",
  "LEGEX-003": "Leg Extension — Machine 3",

  "SLCUR-001": "Seated Leg Curl — Machine 1",
  "SLCUR-002": "Seated Leg Curl — Machine 2",
  "SLCUR-003": "Seated Leg Curl — Machine 3",

  "LLCUR-001": "Lying Leg Curl — Machine 1",
  "LLCUR-002": "Lying Leg Curl — Machine 2",
  "LLCUR-003": "Lying Leg Curl — Machine 3",

  "STCUR-001": "Standing Leg Curl — Machine 1",
  "STCUR-002": "Standing Leg Curl — Machine 2",
  "STCUR-003": "Standing Leg Curl — Machine 3",

  "HIPAB-001": "Hip Abductor — Machine 1",
  "HIPAB-002": "Hip Abductor — Machine 2",
  "HIPAB-003": "Hip Abductor — Machine 3",

  "HIPAD-001": "Hip Adductor — Machine 1",
  "HIPAD-002": "Hip Adductor — Machine 2",
  "HIPAD-003": "Hip Adductor — Machine 3",

  "GLUTKB-001": "Glute Kickback — Machine 1",
  "GLUTKB-002": "Glute Kickback — Machine 2",
  "GLUTKB-003": "Glute Kickback — Machine 3",

  "SCALF-001": "Seated Calf Raise — Machine 1",
  "SCALF-002": "Seated Calf Raise — Machine 2",
  "SCALF-003": "Seated Calf Raise — Machine 3",

  "STCALF-001": "Standing Calf Raise — Machine 1",
  "STCALF-002": "Standing Calf Raise — Machine 2",
  "STCALF-003": "Standing Calf Raise — Machine 3",

  // ---- Arms ----
  "PRCUR-001": "Preacher Curl — Machine 1",
  "PRCUR-002": "Preacher Curl — Machine 2",
  "PRCUR-003": "Preacher Curl — Machine 3",

  "BICUR-001": "Biceps Curl — Machine 1",
  "BICUR-002": "Biceps Curl — Machine 2",
  "BICUR-003": "Biceps Curl — Machine 3",

  "CABCRL-001": "Cable Curl — Station 1",
  "CABCRL-002": "Cable Curl — Station 2",
  "CABCRL-003": "Cable Curl — Station 3",

  "TRIEX-001": "Triceps Extension — Machine 1",
  "TRIEX-002": "Triceps Extension — Machine 2",
  "TRIEX-003": "Triceps Extension — Machine 3",

  "DIPMT-001": "Dip Machine — Machine 1",
  "DIPMT-002": "Dip Machine — Machine 2",
  "DIPMT-003": "Dip Machine — Machine 3",

  "CABPD-001": "Cable Pushdown — Station 1",
  "CABPD-002": "Cable Pushdown — Station 2",
  "CABPD-003": "Cable Pushdown — Station 3",

  // ---- Core / Abs ----
  "ABCR-001": "Ab Crunch — Machine 1",
  "ABCR-002": "Ab Crunch — Machine 2",
  "ABCR-003": "Ab Crunch — Machine 3",

  "RTTOR-001": "Rotary Torso — Machine 1",
  "RTTOR-002": "Rotary Torso — Machine 2",
  "RTTOR-003": "Rotary Torso — Machine 3",

  "CAPCH-001": "Captain’s Chair — Station 1",
  "CAPCH-002": "Captain’s Chair — Station 2",
  "CAPCH-003": "Captain’s Chair — Station 3",

  "DABEN-001": "Decline Ab Bench — Bench 1",
  "DABEN-002": "Decline Ab Bench — Bench 2",
  "DABEN-003": "Decline Ab Bench — Bench 3",

  "CABAB-001": "Cable Crunch — Station 1",
  "CABAB-002": "Cable Crunch — Station 2",
  "CABAB-003": "Cable Crunch — Station 3",

  // ---- Free Weights / Racks / Benches ----
  "FBEN-001": "Flat Bench — Bench 1",
  "FBEN-002": "Flat Bench — Bench 2",
  "FBEN-003": "Flat Bench — Bench 3",

  "IBEN-001": "Incline Bench — Bench 1",
  "IBEN-002": "Incline Bench — Bench 2",
  "IBEN-003": "Incline Bench — Bench 3",

  "DBEN-001": "Decline Bench — Bench 1",
  "DBEN-002": "Decline Bench — Bench 2",
  "DBEN-003": "Decline Bench — Bench 3",

  "SQRK-001": "Squat Rack — Rack 1",
  "SQRK-002": "Squat Rack — Rack 2",
  "SQRK-003": "Squat Rack — Rack 3",

  "PWRK-001": "Power Rack — Rack 1",
  "PWRK-002": "Power Rack — Rack 2",
  "PWRK-003": "Power Rack — Rack 3",

  "DBRCK-001": "Dumbbell Rack — Area 1",
  "DBRCK-002": "Dumbbell Rack — Area 2",
  "DBRCK-003": "Dumbbell Rack — Area 3",

  // ---- Cardio (optional) ----
  "TRED-001": "Treadmill — Unit 1",
  "TRED-002": "Treadmill — Unit 2",
  "TRED-003": "Treadmill — Unit 3",

  "ELIP-001": "Elliptical — Unit 1",
  "ELIP-002": "Elliptical — Unit 2",
  "ELIP-003": "Elliptical — Unit 3",

  "STAIR-001": "Stair Climber — Unit 1",
  "STAIR-002": "Stair Climber — Unit 2",
  "STAIR-003": "Stair Climber — Unit 3",

  "BIKE-001": "Stationary Bike — Unit 1",
  "BIKE-002": "Stationary Bike — Unit 2",
  "BIKE-003": "Stationary Bike — Unit 3",

  "ROW-001": "Rower — Unit 1",
  "ROW-002": "Rower — Unit 2",
  "ROW-003": "Rower — Unit 3"
};

const machineName = MACHINE_MAP[machineId] || `Machine (${machineId})`;

/* Storage: workouts per user+machine */
function storageKeyFor(mid) {
  return `scanliftlog_workouts_v1:${userId}:${mid}`;
}
function loadWorkouts() {
  return safeJSONParse(localStorage.getItem(storageKeyFor(machineId)) || "[]", []);
}
function saveWorkouts(arr) {
  localStorage.setItem(storageKeyFor(machineId), JSON.stringify(arr));
}

/* ---------- UI Elements ---------- */
const setsContainer = document.getElementById('setsContainer');
const dateInput = document.getElementById('dateInput');
const notesInput = document.getElementById('notesInput');

/* ---------- Sets UI ---------- */
function createSetRow(setIndex, weight="", reps="") {
  const row = document.createElement('div');
  row.className = 'setRow';
  row.dataset.index = String(setIndex);

  const badge = document.createElement('div');
  badge.className = 'setBadge';
  badge.textContent = String(setIndex + 1);

  const w = document.createElement('input');
  w.placeholder = 'e.g., 180';
  w.inputMode = 'decimal';
  w.value = weight;

  const r = document.createElement('input');
  r.placeholder = 'e.g., 10';
  r.inputMode = 'numeric';
  r.value = reps;

  const del = document.createElement('button');
  del.className = 'iconBtn danger';
  del.type = 'button';
  del.textContent = '−';
  del.title = 'Remove set';
  del.onclick = () => {
    row.remove();
    renumberSets();
  };

  row.appendChild(badge);
  row.appendChild(w);
  row.appendChild(r);
  row.appendChild(del);
  return row;
}

function renumberSets() {
  const rows = Array.from(setsContainer.querySelectorAll('.setRow'));
  rows.forEach((row, i) => {
    row.dataset.index = String(i);
    row.querySelector('.setBadge').textContent = String(i + 1);
  });
}

function addSet(weight="", reps="") {
  const idx = setsContainer.querySelectorAll('.setRow').length;
  setsContainer.appendChild(createSetRow(idx, weight, reps));
}

function clearCurrentSets() {
  setsContainer.innerHTML = "";
  addSet("", "");
}

/* ---------- Save / History ---------- */
function readCurrentSets() {
  const rows = Array.from(setsContainer.querySelectorAll('.setRow'));
  const sets = rows.map(row => {
    const inputs = row.querySelectorAll('input');
    return {
      weight: (inputs[0].value || "").trim(),
      reps: (inputs[1].value || "").trim()
    };
  }).filter(s => s.weight || s.reps);
  return sets;
}

function getTopSet(sets) {
  let best = null;
  let bestW = -Infinity;
  for (const s of sets) {
    const w = parseFloat(String(s.weight).replace(/[^0-9.]/g,''));
    if (!Number.isNaN(w) && w > bestW) { bestW = w; best = s; }
  }
  return best || sets[0] || null;
}

function renderHistory() {
  const tbody = document.getElementById('historyBody');
  tbody.innerHTML = "";

  const workouts = loadWorkouts();
  if (!workouts.length) {
    tbody.innerHTML = `<tr><td colspan="5" class="muted">No workouts saved yet.</td></tr>`;
    return;
  }

  const sorted = workouts.slice().sort((a,b) => (b.ts||0) - (a.ts||0));
  for (const w of sorted) {
    const top = getTopSet(w.sets || []);
    const topText = top ? `${escapeHtml(top.weight || "—")} x ${escapeHtml(top.reps || "—")}` : "—";

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${escapeHtml(w.date || "")}</td>
      <td>${(w.sets||[]).length}</td>
      <td>${topText}</td>
      <td>
        <details>
          <summary>View sets</summary>
          ${w.notes ? `<div class="muted" style="margin-top:6px;">Notes: ${escapeHtml(w.notes)}</div>` : ""}
          <table class="setsMini">
            <thead><tr><th>Set</th><th>Weight</th><th>Reps</th></tr></thead>
            <tbody>
              ${(w.sets||[]).map((s,i)=>`
                <tr><td>${i+1}</td><td>${escapeHtml(s.weight||"")}</td><td>${escapeHtml(s.reps||"")}</td></tr>
              `).join("")}
            </tbody>
          </table>
        </details>
      </td>
      <td class="muted">${escapeHtml(w.savedAt || "")}</td>
    `;
    tbody.appendChild(tr);
  }
}

/* ---------- Wire up ---------- */
document.getElementById('year').textContent = String(new Date().getFullYear());
document.getElementById('machinePill').textContent = machineName;
document.getElementById('userPill').textContent = `User: ${userId.slice(0,8)}…`;
document.getElementById('historyScopeBadge').textContent = `Scope: ${machineId}`;
document.getElementById('resetUserBtn').addEventListener('click', resetUser);

dateInput.value = todayISO();

document.getElementById('addSetBtn').addEventListener('click', () => addSet("", ""));
document.getElementById('clearCurrentBtn').addEventListener('click', clearCurrentSets);

document.getElementById('saveWorkoutBtn').addEventListener('click', () => {
  const date = (dateInput.value || todayISO()).trim();
  const notes = (notesInput.value || "").trim();
  const sets = readCurrentSets();

  if (!sets.length) {
    alert("Add at least one set (weight and/or reps) before saving.");
    return;
  }

  const workouts = loadWorkouts();
  workouts.push({
    ts: Date.now(),
    date,
    notes,
    sets,
    savedAt: nowReadable()
  });
  saveWorkouts(workouts);

  notesInput.value = "";
  clearCurrentSets();
  renderHistory();
});

document.getElementById('clearHistoryBtn').addEventListener('click', () => {
  if (!confirm("Clear ALL history for this machine on this device?")) return;
  saveWorkouts([]);
  renderHistory();
});

/* Init */
clearCurrentSets();
renderHistory();
</script>
</body>
</html>
